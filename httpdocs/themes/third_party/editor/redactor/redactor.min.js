(function(b){function m(a,c){return new m.prototype.init(a,c)}var q=0,n=!1;"use strict";var p=function(a){this[0]=a.startOffset;this[1]=a.endOffset;this.range=a;return this};p.prototype.equals=function(){return this[0]===this[1]};b.fn.redactor=function(a){var c=[],d=Array.prototype.slice.call(arguments,1);"string"===typeof a?this.each(function(){var e=b.data(this,"redactor");if("undefined"!==typeof e&&b.isFunction(e[a])){var f=e[a].apply(e,d);void 0!==f&&f!==e&&c.push(f)}else return b.error('No such method "'+
a+'" for Redactor')}):this.each(function(){b.data(this,"redactor")||b.data(this,"redactor",m(this,a))});return 0===c.length?this:1===c.length?c[0]:c};b.Redactor=m;b.Redactor.VERSION="9.0.4";b.Redactor.opts={initCallback:!1,changeCallback:!1,focusCallback:!1,blurCallback:!1,keydownCallback:!1,keyupCallback:!1,execCommandCallback:!1,pasteBeforeCallback:!1,pasteAfterCallback:!1,autosaveCallback:!1,imageUploadCallback:!1,imageUploadErrorCallback:!1,imageDeleteCallback:!1,fileUploadCallback:!1,fileUploadErrorCallback:!1,
rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:"en",direction:"ltr",placeholder:!1,wym:!1,mobile:!0,cleanup:!0,removeEmptyTags:!0,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,shortcuts:!0,autosave:!1,autosaveInterval:60,plugins:!1,linkAnchor:!1,linkEmail:!1,linkProtocol:"http://",imageGetJson:!1,imageUpload:!1,fileUpload:!1,s3:!1,uploadFields:!1,observeImages:!0,modalOverlay:!0,tabFocus:!0,air:!1,airButtons:"formatting | bold italic deleted | unorderedlist orderedlist outdent indent | fontcolor backcolor".split(" "),
toolbar:!0,toolbarFixed:!1,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,buttonSource:!0,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:"html | formatting | bold italic deleted | unorderedlist orderedlist outdent indent | image video file table link | fontcolor backcolor | alignment | horizontalrule".split(" "),colors:"#ffffff #000000 #eeece1 #1f497d #4f81bd #c0504d #9bbb59 #8064a2 #4bacc6 #f79646 #ffff00 #f2f2f2 #7f7f7f #ddd9c3 #c6d9f0 #dbe5f1 #f2dcdb #ebf1dd #e5e0ec #dbeef3 #fdeada #fff2ca #d8d8d8 #595959 #c4bd97 #8db3e2 #b8cce4 #e5b9b7 #d7e3bc #ccc1d9 #b7dde8 #fbd5b5 #ffe694 #bfbfbf #3f3f3f #938953 #548dd4 #95b3d7 #d99694 #c3d69b #b2a2c7 #b7dde8 #fac08f #f2c314 #a5a5a5 #262626 #494429 #17365d #366092 #953734 #76923c #5f497a #92cddc #e36c09 #c09100 #7f7f7f #0c0c0c #1d1b10 #0f243e #244061 #632423 #4f6128 #3f3151 #31859b #974806 #7f6000".split(" "),
activeButtons:"deleted italic bold underline unorderedlist orderedlist alignleft aligncenter alignright justify table".split(" "),activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:!1,formattingTags:"p blockquote pre h1 h2 h3 h4".split(" "),linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:"html head link body meta script style applet".split(" "),
boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:"P H1 H2 H3 H4 H5 H6 DD DL DT DIV TD BLOCKQUOTE OUTPUT FIGCAPTION ADDRESS SECTION HEADER FOOTER ASIDE ARTICLE".split(" "),ownLine:"area body head hr i?frame link meta noscript style script table tbody thead tfoot".split(" "),contOwnLine:"li dt dt h[1-6] option script".split(" "),
newLevel:"blockquote div dl fieldset form frameset map ol p pre select td th tr ul".split(" "),blockLevelElements:"P H1 H2 H3 H4 H5 H6 DD DL DT DIV LI BLOCKQUOTE OUTPUT FIGCAPTION PRE ADDRESS SECTION HEADER FOOTER ASIDE ARTICLE".split(" "),langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",
header3:"Header 3",header4:"Header 4",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",
rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",
horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)"}}};m.fn=b.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(a,c){this.$element=this.$source=b(a);this.uuid=q++;this.opts=b.extend({},b.Redactor.opts,this.$element.data(),c);this.start=!0;this.dropdowns=[];this.sourceHeight=this.$source.css("height");
this.sourceWidth=this.$source.css("width");this.opts.fullpage&&(this.opts.iframe=!0);this.opts.linebreaks&&(this.opts.paragraphy=!1);this.opts.paragraphy&&(this.opts.linebreaks=!1);this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0);this.document=document;this.window=window;this.savedSel=!1;this.cleanlineBefore=RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+
")[ >]");this.cleannewLevel=RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]");this.rTestBlock=RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(!1===this.opts.linebreaks&&(!1!==this.opts.allowedTags&&"-1"===b.inArray("p",this.opts.allowedTags)&&this.opts.allowedTags.push("p"),!1!==this.opts.deniedTags)){var d=b.inArray("p",this.opts.deniedTags);"-1"!==d&&this.opts.deniedTags.splice(d,d)}if(this.browser("msie")||this.browser("opera"))this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,
"horizontalrule");this.opts.curLang=this.opts.langs[this.opts.lang];this.buildStart()},initToolbar:function(a){return{html:{title:a.html,func:"toggle"},formatting:{title:a.formatting,func:"show",dropdown:{p:{title:a.paragraph,func:"formatBlocks"},blockquote:{title:a.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:a.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:a.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:a.header2,func:"formatBlocks",
className:"redactor_format_h2"},h3:{title:a.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:a.header4,func:"formatBlocks",className:"redactor_format_h4"}}},bold:{title:a.bold,exec:"bold"},italic:{title:a.italic,exec:"italic"},deleted:{title:a.deleted,exec:"strikethrough"},underline:{title:a.underline,exec:"underline"},unorderedlist:{title:"&bull; "+a.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+a.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+
a.outdent,func:"indentingOutdent"},indent:{title:"> "+a.indent,func:"indentingIndent"},image:{title:a.image,func:"imageShow"},video:{title:a.video,func:"videoShow"},file:{title:a.file,func:"fileShow"},table:{title:a.table,func:"show",dropdown:{insert_table:{title:a.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:a.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:a.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:a.insert_column_left,
func:"tableAddColumnLeft"},insert_column_right:{title:a.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:a.add_head,func:"tableAddHead"},delete_head:{title:a.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:a.delete_column,func:"tableDeleteColumn"},delete_row:{title:a.delete_row,func:"tableDeleteRow"},delete_table:{title:a.delete_table,func:"tableDeleteTable"}}},link:{title:a.link,func:"show",dropdown:{link:{title:a.link_insert,
func:"linkShow"},unlink:{title:a.unlink,exec:"unlink"}}},fontcolor:{title:a.fontcolor,func:"show"},backcolor:{title:a.backcolor,func:"show"},alignment:{title:a.alignment,func:"show",dropdown:{alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,func:"alignmentCenter"},alignright:{title:a.align_right,func:"alignmentRight"},justify:{title:a.align_justify,func:"alignmentJustify"}}},alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,
func:"alignmentCenter"},alignright:{title:a.align_right,func:"alignmentRight"},justify:{title:a.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:a.horizontalrule}}},callback:function(a,c,d){a=this.opts[a+"Callback"];return b.isFunction(a)?!1===c?a.call(this,d):a.call(this,c,d):d},destroy:function(){clearInterval(this.autosaveInterval);b(window).off(".redactor");this.$element.off(".redactor").removeData("redactor");var a=this.get();if(this.opts.textareamode)this.$box.after(this.$source),
this.$box.remove(),this.$source.val(a).show();else{var c=this.$editor;this.opts.iframe&&(c=this.$element);this.$box.after(c);this.$box.remove();c.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(a).show()}},getObject:function(){return b.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:!1},getToolbar:function(){return this.$toolbar},get:function(){return this.$source.val()},
getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var a=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:!0,dir:this.opts.direction});return a},set:function(a,c){a=a.toString();this.opts.fullpage?this.setCodeIframe(a):this.setEditor(a,c)},setEditor:function(a,c){!1!==c&&(a=this.cleanSavePreCode(a),a=this.cleanStripTags(a),a=this.cleanConvertProtected(a),a=this.cleanConvertInlineTags(a),a=!1===this.opts.linebreaks?this.cleanConverters(a):
a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));a=this.cleanEmpty(a);this.$editor.html(a);this.sync()},setCodeIframe:function(a){var c=this.iframePage();this.$frame[0].src="about:blank";a=this.cleanConvertProtected(a);a=this.cleanConvertInlineTags(a);a=this.cleanRemoveSpaces(a);c.open();c.write(a);c.close();this.opts.fullpage&&(this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction}));this.sync()},setFullpageOnInit:function(a){a=this.cleanSavePreCode(a,
!0);a=this.cleanConverters(a);a=this.cleanEmpty(a);this.$editor.html(a);this.sync()},sync:function(){var a="";this.cleanUnverified();a=this.opts.fullpage?this.getCodeIframe():this.$editor.html();a=this.syncClean(a);a=this.cleanRemoveSpaces(a);a=this.cleanRemoveEmptyTags(a);a=a.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");"<br>"===b.trim(a)&&(a="");""!==a&&(a=this.cleanHtml(a));a=this.callback("syncBefore",!1,a);this.$source.val(a);"undefined"!=typeof htmlEncode&&b("#"+this.$element[0].id+
"_code").html(htmlEncode(a));this.callback("syncAfter",!1,a);!1===this.start&&this.callback("change",!1,a)},syncClean:function(a){this.opts.fullpage||(a=this.cleanStripTags(a));a=b.trim(a);a=this.placeholderRemoveFromCode(a);a=a.replace(/&#x200b;/gi,"");a=a.replace(/&#8203;/gi,"");a=a.replace(/&nbsp;/gi," ");a=a.replace("\x3c!--?php","<?php");a=a.replace("?--\x3e","?>");a=a.replace(/ data-tagblock=""/gi,"");a=a.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,
"</$1>");a=a.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>");a=a.replace(/<span(.*?)data-redactor-inlineMethods=""(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>");a=a.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/<span\s*?id="selection-marker(.*?)"(.*?)>([\w\W]*?)<\/span>/gi,"");a=a.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");return a=this.cleanReConvertProtected(a)},
buildStart:function(){this.content="";this.$box=b('<div class="redactor_box" />');"TEXTAREA"===this.$source[0].tagName&&(this.opts.textareamode=!0);!1===this.opts.mobile&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),
this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content));this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.content=this.opts.textareamode?b.trim(this.$source.val()):b.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=b("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=
this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(a){return b("<textarea />").attr("name",a.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(a){b.each(this.$source.get(0).className.split(/\s+/),function(c,b){a.addClass("redactor_"+b)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction});this.$source.attr("dir",
this.opts.direction).hide();this.set(this.content)},buildOptions:function(){var a=this.$editor;this.opts.iframe&&(a=this.$frame);this.opts.tabindex&&a.attr("tabindex",this.opts.tabindex);this.opts.minHeight&&a.css("min-height",this.opts.minHeight+"px");this.opts.wym&&this.$editor.addClass("redactor_editor_wym");this.opts.autoresize||a.css("height",this.sourceHeight)},buildAfter:function(){this.start=!1;this.opts.toolbar&&(this.opts.toolbar=this.initToolbar(this.opts.curLang),this.toolbarBuild());
this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();this.opts.autosave&&this.autosave();setTimeout(b.proxy(this.observeStart,this),4);if(this.browser("mozilla"))try{this.document.execCommand("enableObjectResizing",!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1)}catch(a){}this.opts.focus&&setTimeout(b.proxy(this.focus,this),100);this.opts.visual||setTimeout(b.proxy(function(){this.opts.visual=!0;this.toggle(!1)},this),200);this.callback("init")},buildBindKeyboard:function(){var a=
!1;this.browser("webkit")&&-1===navigator.userAgent.indexOf("Chrome")&&536>this.browser("version").split(".")[0]&&(a=!0);this.$editor.on("paste.redactor",b.proxy(function(c){if(a||this.browser("opera"))return!0;if(this.opts.cleanup){n=!0;this.selectionSave();this.selectall||(!0===this.opts.autoresize?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var d=this.extractContent();setTimeout(b.proxy(function(){var a=this.extractContent();
this.$editor.append(d);this.selectionRestore();a=this.getFragmentHtml(a);this.pasteClean(a);!0===this.opts.autoresize&&this.$editor.css("height","auto")},this),1)}},this));this.$editor.on("keydown.redactor",b.proxy(function(a){if(n)return!1;var d=a.which,e=a.ctrlKey||a.metaKey,f=this.getParent(),g=this.getCurrent(),h=this.getBlock(),k=!1;this.callback("keydown",a);if(f&&"PRE"===b(f).get(0).tagName||g&&"PRE"===b(g).get(0).tagName)k=!0,d===this.keyCode.DOWN&&this.insertAfterLastElement(h);d===this.keyCode.DOWN&&
(f&&"BLOCKQUOTE"===b(f).get(0).tagName&&this.insertAfterLastElement(f),g&&"BLOCKQUOTE"===b(g).get(0).tagName&&this.insertAfterLastElement(g));e&&!a.shiftKey&&this.shortcuts(a,d);if(!e||90!==d||a.shiftKey||a.altKey)if(e&&90===d&&a.shiftKey&&!a.altKey)a.preventDefault(),0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand("redo",!1,!1);else{e&&65===d?this.selectall=!0:d==this.keyCode.LEFT_WIN||e||(this.selectall=!1);if(d!=this.keyCode.ENTER||a.shiftKey||a.ctrlKey||a.metaKey)d===
this.keyCode.ENTER&&(a.ctrlKey||a.shiftKey)&&(this.bufferSet(),a.preventDefault(),this.insertLineBreak());else{if(1==f.nodeType&&("TD"==f.tagName||"TH"==f.tagName))return this.bufferSet(),this.insertNode(document.createElement("br")),a.preventDefault(),!1;if(!0===k)return this.bufferSet(),a.preventDefault(),g=b(g).parent().text(),this.insertNode(document.createTextNode("\n")),-1==g.search(/\s$/)&&this.insertNode(document.createTextNode("\n")),this.sync(),!1;if(!this.opts.linebreaks)if(h&&this.opts.rBlockTest.test(h.tagName))this.bufferSet(),
setTimeout(b.proxy(function(){var a=this.getBlock();if("DIV"===a.tagName&&!b(a).hasClass("redactor_editor")){var c=b("<p>"+this.opts.invisibleSpace+"</p>");b(a).replaceWith(c);this.selectionStart(c)}},this),1);else if(!1===h)return this.bufferSet(),a=b("<p>"+this.opts.invisibleSpace+"</p>"),this.insertNode(a[0]),this.selectionStart(a),!1;if(this.opts.linebreaks)if(h&&this.opts.rBlockTest.test(h.tagName))this.bufferSet(),setTimeout(b.proxy(function(){var a=this.getBlock();"DIV"!==a.tagName&&"P"!==
a.tagName||b(a).hasClass("redactor_editor")||this.replaceLineBreak(a)},this),1);else{this.bufferSet();this.insertLineBreak();a.preventDefault();return}if("BLOCKQUOTE"==h.tagName||"FIGCAPTION"==h.tagName){this.bufferSet();this.insertLineBreak();a.preventDefault();return}}if(d===this.keyCode.TAB&&this.opts.shortcuts){if(!this.opts.tabFocus||this.isEmpty(this.get()))return!0;a.preventDefault();!0!==k||a.shiftKey?a.shiftKey?this.indentingOutdent():this.indentingIndent():(this.bufferSet(),this.insertNode(document.createTextNode("\t")),
this.sync());return!1}d===this.keyCode.BACKSPACE&&("undefined"!==typeof g.tagName&&/^(H[1-6])$/i.test(g.tagName)&&(a=!1===this.opts.linebreaks?b("<p>"+this.opts.invisibleSpace+"</p>"):b("<br>"+this.opts.invisibleSpace),b(g).replaceWith(a),this.selectionStart(a)),"undefined"!==typeof g.nodeValue&&null!==g.nodeValue&&(a=b.trim(g.nodeValue.replace(/[^\u0000-~]/g,"")),g.remove&&(3===g.nodeType&&8203==g.nodeValue.charCodeAt(0)&&""==a)&&g.remove()))}else a.preventDefault(),this.opts.buffer.length?this.bufferUndo():
this.document.execCommand("undo",!1,!1)},this));this.$editor.on("keyup.redactor",b.proxy(function(a){if(n)return!1;var d=a.which,e=this.getParent(),f=this.getCurrent();this.opts.linebreaks||(3!=f.nodeType||!1!=e&&"BODY"!=e.tagName)||(e=b("<p>").append(b(f).clone()),b(f).replaceWith(e),f=b(e).next(),"undefined"!==typeof f[0]&&"BR"==f[0].tagName&&f.remove(),this.selectionEnd(e));this.opts.convertLinks&&d===this.keyCode.ENTER&&this.formatLinkify(this.opts.linkProtocol);if(!1===this.opts.linebreaks&&
(d===this.keyCode.DELETE||d===this.keyCode.BACKSPACE))return this.formatEmpty(a);this.callback("keyup",a);this.sync()},this));if(b.isFunction(this.opts.focusCallback))this.$editor.on("focus.redactor",b.proxy(this.opts.focusCallback,this));if(b.isFunction(this.opts.blurCallback))this.$editor.on("blur.redactor",b.proxy(this.opts.blurCallback,this))},buildPlugins:function(){this.opts.plugins&&b.each(this.opts.plugins,b.proxy(function(a,c){RedactorPlugins[c]&&(b.extend(this,RedactorPlugins[c]),b.isFunction(RedactorPlugins[c].init)&&
this.init())},this))},iframeStart:function(){this.iframeCreate();this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(a){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(a).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=b('<iframe style="width: 100%;" frameborder="0" />').one("load",b.proxy(function(){if(this.opts.fullpage){this.iframePage();
""===this.content&&(this.content=this.opts.invisibleSpace);this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var a=setInterval(b.proxy(function(){this.$frame.contents().find("body").html()&&(clearInterval(a),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var a=this.iframeDoc();a.documentElement&&a.removeChild(a.documentElement);return a},iframeAddCss:function(a){a=a||
this.opts.css;this.isString(a)&&this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+a+'" />');b.isArray(a)&&b.each(a,b.proxy(function(a,b){this.iframeAddCss(b)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction});this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window);this.iframeAddCss();this.opts.fullpage?this.setFullpageOnInit(this.$editor.html()):
this.set(this.content);this.buildOptions();this.buildAfter()},placeholderStart:function(a){return this.isEmpty(a)&&(this.$element.attr("placeholder")&&(this.opts.placeholder=this.$element.attr("placeholder")),""===this.opts.placeholder&&(this.opts.placeholder=!1),!1!==this.opts.placeholder)?(this.opts.focus=!1,this.$editor.one("focus.redactor_placeholder",b.proxy(this.placeholderFocus,this)),b('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",!1).text(this.opts.placeholder)):
!1},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var a="";!1===this.opts.linebreaks&&(a=this.opts.emptyHtml);this.$editor.off("focus.redactor_placeholder");this.$editor.html(a);!1===this.opts.linebreaks&&this.selectionStart(this.$editor.children()[0]);this.sync()},placeholderRemove:function(){this.opts.placeholder=!1;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(a){return a.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,
"")},shortcuts:function(a,c){this.opts.shortcuts&&(a.altKey?48===c?this.shortcutsLoadFormat(a,"p"):49===c?this.shortcutsLoadFormat(a,"h1"):50===c?this.shortcutsLoadFormat(a,"h2"):51===c?this.shortcutsLoadFormat(a,"h3"):52===c?this.shortcutsLoadFormat(a,"h4"):53===c?this.shortcutsLoadFormat(a,"h5"):54===c&&this.shortcutsLoadFormat(a,"h6"):77===c?this.shortcutsLoad(a,"removeFormat"):66===c?this.shortcutsLoad(a,"bold"):73===c?this.shortcutsLoad(a,"italic"):74===c?this.shortcutsLoad(a,"insertunorderedlist"):
75===c?this.shortcutsLoad(a,"insertorderedlist"):72===c?this.shortcutsLoad(a,"superscript"):76===c&&this.shortcutsLoad(a,"subscript"))},shortcutsLoad:function(a,c){a.preventDefault();this.execCommand(c,!1)},shortcutsLoadFormat:function(a,c){a.preventDefault();this.formatBlocks(c)},focus:function(){this.browser("opera")?this.$editor.focus():this.window.setTimeout(b.proxy(this.focusSet,this,!0),1)},focusEnd:function(){this.focusSet()},focusSet:function(a){this.$editor.focus();var c=this.getRange();
c.selectNodeContents(this.$editor[0]);c.collapse(a||!1);a=this.getSelection();a.removeAllRanges();a.addRange(c)},toggle:function(a){if(this.opts.visual){!1!==a&&this.selectionSave();var c=null;this.opts.iframe?(c=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr("contenteditable"),this.$frame.hide()):(c=this.$editor.innerHeight(),this.$editor.hide());this.modified=a=this.$source.val();this.$source.height(c).show().focus();this.$source.on("keydown.redactor-textarea",function(a){if(9===
a.keyCode){a=b(this);var c=a.get(0).selectionStart;a.val(a.val().substring(0,c)+"\t"+a.val().substring(a.get(0).selectionEnd));a.get(0).selectionStart=a.get(0).selectionEnd=c+1;return!1}});this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=!1}else a=this.$source.hide().val(),"undefined"!==typeof this.modified&&(this.modified=this.cleanRemoveSpaces(this.modified,!1)!==this.cleanRemoveSpaces(a,!1)),this.modified&&(this.opts.fullpage&&""===a?this.setFullpageOnInit(a):(this.set(a),
this.opts.fullpage&&this.buildBindKeyboard())),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr("contenteditable",!0),this.$source.off("keydown.redactor-textarea"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive("html"),this.opts.visual=!0},autosave:function(){var a=!1;this.autosaveInterval=setInterval(b.proxy(function(){var c=this.get();a!==c&&b.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+
"="+escape(encodeURIComponent(c)),success:b.proxy(function(b){this.callback("autosave",!1,b);a=c},this)})},this),1E3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var a=this.opts.buttons.indexOf("html"),c=this.opts.buttons[a+1];this.opts.buttons.splice(a,1);"|"===c&&this.opts.buttons.splice(a,1)}b.extend(this.opts.toolbar,this.opts.buttonsCustom);b.each(this.opts.buttonsAdd,b.proxy(function(a,c){this.opts.buttons.push(c)},
this));this.opts.toolbar&&b.each(this.opts.toolbar.formatting.dropdown,b.proxy(function(a,c){"-1"==b.inArray(a,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[a]},this));if(0===this.opts.buttons.length)return!1;this.airEnable();this.$toolbar=b("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid);this.opts.air?(this.$air=b('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide(),this.$air.append(this.$toolbar),b("body").append(this.$air)):
this.opts.toolbarExternal?b(this.opts.toolbarExternal).html(this.$toolbar):this.$box.prepend(this.$toolbar);b.each(this.opts.buttons,b.proxy(function(a,c){if("|"===c)this.$toolbar.append(b(this.opts.buttonSeparator));else if(this.opts.toolbar[c]){var f=this.opts.toolbar[c];if(!1===this.opts.fileUpload&&"file"===c)return!0;this.$toolbar.append(b("<li>").append(this.buttonBuild(c,f)))}},this));this.$toolbar.find("a").attr("tabindex","-1");this.opts.toolbarFixed&&(this.toolbarObserveScroll(),b(document).on("scroll.redactor",
b.proxy(this.toolbarObserveScroll,this)));this.opts.activeButtons&&(a=b.proxy(this.buttonActiveObserver,this),this.$editor.on("mouseup.redactor keyup.redactor",a))},toolbarObserveScroll:function(){var a=b(this.document).scrollTop(),c=this.$box.offset().top,d=0,e=c+this.$box.height()+40;a>c?(c="100%",this.opts.toolbarFixedBox&&(d=this.$box.offset().left,c=this.$box.innerWidth(),this.$toolbar.addClass("toolbar_fixed_box")),this.toolbarFixed=!0,this.$toolbar.css({position:"fixed",width:c,zIndex:1005,
top:this.opts.toolbarFixedTopOffset+"px",left:d}),a<e?this.$toolbar.css("visibility","visible"):this.$toolbar.css("visibility","hidden")):(this.toolbarFixed=!1,this.$toolbar.css({position:"relative",width:"auto",top:0,left:d}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass("toolbar_fixed_box"))},airEnable:function(){if(this.opts.air)this.$editor.on("mouseup.redactor keyup.redactor",this,b.proxy(function(a){var c=this.getSelectionText();"mouseup"===a.type&&""!=c&&this.airShow(a);"keyup"===a.type&&
(a.shiftKey&&""!=c)&&(a=b(this.getElement(this.getSelection().focusNode)),c=a.offset(),c.height=a.height(),this.airShow(c,!0))},this))},airShow:function(a,c){if(this.opts.air){var d,e;b(".redactor_air").hide();c?(d=a.left,e=a.top+a.height+14,this.opts.iframe&&(e+=this.$box.position().top-b(this.document).scrollTop(),d+=this.$box.position().left)):(e=this.$air.innerWidth(),d=a.clientX,b(this.document).width()<d+e&&(d-=e),e=a.clientY+14,this.opts.iframe?(e+=this.$box.position().top,d+=this.$box.position().left):
e+=b(this.document).scrollTop());this.$air.css({left:d+"px",top:e+"px"}).show();this.airBindHide()}},airBindHide:function(){if(this.opts.air){var a=b.proxy(function(a){b(a).on("mousedown.redactor",b.proxy(function(d){0===b(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),b(a).off(d))},this)).on("keydown.redactor",b.proxy(function(d){d.which===this.keyCode.ESC&&this.getSelection().collapseToStart();this.$air.fadeOut(100);b(a).off(d)},this))},this);a(document);
this.opts.iframe&&a(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var a=b.proxy(function(a){b(a).on("mousemove.redactor",b.proxy(function(d){0===b(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),b(a).off(d))},this))},this);a(document);this.opts.iframe&&a(this.document)}},pickerBuild:function(a,c){a.width(210);var d="color";"backcolor"===c&&(d="background-color");for(var e=this.opts.colors.length,f=this,g=0;g<e;g++){var h=this.opts.colors[g],h=b('<a rel="'+h+'" href="javascript:;" class="redactor_color_link"></a>').css({backgroundColor:h});
a.append(h);h.on("click",function(){var a=b(this).attr("rel");"backcolor"===c&&(a=b(this).css("background-color"));f.pickerSet(d,a)})}e=b('<a href="javascript:;" class="redactor_color_none"></a>').html(this.opts.curLang.none).on("click",function(){f.pickerSet(d,!1)});a.append(e)},pickerSet:function(a,c){this.bufferSet();this.$editor.focus();this.inlineRemoveStyle(a);!1!==c&&this.inlineSetStyle(a,c);this.opts.air&&this.$air.fadeOut(100);this.sync()},dropdownBuild:function(a,c){b.each(c,b.proxy(function(c,
e){e.className||(e.className="");var f;"separator"===e.name?f=b('<a class="redactor_separator_drop">'):(f=b('<a href="javascript:;" class="'+e.className+" redactor_dropdown_"+c+'">'+e.title+"</a>"),f.on("click",b.proxy(function(a){a.preventDefault&&a.preventDefault();this.browser("msie")&&(a.returnValue=!1);e.callback&&e.callback.call(this,c,f,e,a);e.exec&&this.execCommand(e.exec,c);if(e.func)this[e.func](c);this.buttonActiveObserver();this.opts.air&&this.$air.fadeOut(100)},this)));a.append(f)},this))},
dropdownShow:function(a,c,d){if(!this.opts.visual)return a.preventDefault(),!1;if(this.buttonGet(d).hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll();this.buttonActive(d);this.buttonGet(d).addClass("dropact");d=this.buttonGet(d).position();var e=d.left+"px";this.opts.air?c.css({position:"absolute",left:e,top:"29px"}).show():this.opts.toolbarFixed&&this.toolbarFixed?c.css({position:"fixed",left:e,top:"29px"}).show():c.css({position:"absolute",left:e,top:d.top+29+"px"}).show()}d=
b.proxy(function(a){this.dropdownHide(a,c)},this);b(document).one("click",d);this.$editor.one("click",d);a.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");b(".redactor_dropdown").hide()},dropdownHide:function(a,c){b(a.target).hasClass("dropact")||(c.removeClass("dropact"),this.dropdownHideAll())},buttonBuild:function(a,c){var d=b('<a href="javascript:;" title="'+c.title+'" class="redactor_btn redactor_btn_'+a+'"></a>'),
e=b('<div class="redactor_dropdown" style="display: none;">');d.on("click",b.proxy(function(b){b.preventDefault&&b.preventDefault();this.browser("msie")&&(b.returnValue=!1);if(d.hasClass("redactor_button_disabled"))return!1;!1!==this.isFocused()||c.exec||this.$editor.focus();c.exec?(this.$editor.focus(),this.execCommand(c.exec,a),this.airBindMousemoveHide()):c.func&&"show"!==c.func?(this[c.func](a),this.airBindMousemoveHide()):c.callback?(c.callback.call(this,a,d,c,b),this.airBindMousemoveHide()):
("backcolor"===a||"fontcolor"===a||c.dropdown)&&this.dropdownShow(b,e,a);this.buttonActiveObserver(!1,a)},this));if("backcolor"===a||"fontcolor"===a||c.dropdown)e.appendTo(this.$toolbar),"backcolor"===a||"fontcolor"===a?this.pickerBuild(e,a):this.dropdownBuild(e,c.dropdown);return d},buttonGet:function(a){return this.opts.toolbar?b(this.$toolbar.find("a.redactor_btn_"+a)):!1},buttonActiveToggle:function(a){a=this.buttonGet(a);a.hasClass("redactor_act")?a.removeClass("redactor_act"):a.addClass("redactor_act")},
buttonActive:function(a){this.buttonGet(a).addClass("redactor_act")},buttonInactive:function(a){this.buttonGet(a).removeClass("redactor_act")},buttonInactiveAll:function(a){b.each(this.opts.toolbar,b.proxy(function(c){c!=a&&this.buttonInactive(c)},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},
buttonChangeIcon:function(a,c){this.buttonGet(a).addClass("redactor_btn_"+c)},buttonRemoveIcon:function(a,c){this.buttonGet(a).removeClass("redactor_btn_"+c)},buttonAddSeparator:function(){this.$toolbar.append(b(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(a){this.buttonGet(a).parent().after(b(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(a){this.buttonGet(a).parent().before(b(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(a){this.buttonGet(a).parent().next().remove()},
buttonRemoveSeparatorBefore:function(a){this.buttonGet(a).parent().prev().remove()},buttonSetRight:function(a){this.opts.toolbar&&this.buttonGet(a).parent().addClass("redactor_btn_right")},buttonSetLeft:function(a){this.opts.toolbar&&this.buttonGet(a).parent().removeClass("redactor_btn_right")},buttonAdd:function(a,c,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,{title:c,callback:d,dropdown:e}),this.$toolbar.append(b("<li>").append(a)))},buttonAddFirst:function(a,c,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,
{title:c,callback:d,dropdown:e}),this.$toolbar.prepend(b("<li>").append(a)))},buttonAddAfter:function(a,c,d,e,f){this.opts.toolbar&&(c=this.buttonBuild(c,{title:d,callback:e,dropdown:f}),this.buttonGet(a).parent().after(b("<li>").append(c)))},buttonAddBefore:function(a,c,d,e,f){this.opts.toolbar&&(c=this.buttonBuild(c,{title:d,callback:e,dropdown:f}),this.buttonGet(a).parent().before(b("<li>").append(c)))},buttonRemove:function(a,c){var b=this.buttonGet(a);c&&b.parent().next().remove();b.parent().removeClass("redactor_btn_right");
b.remove()},buttonActiveObserver:function(a,c){var d=this.getParent();this.buttonInactiveAll(c);if(!1===a&&"html"!==c)this.buttonActiveToggle(c);else{d&&"A"===d.tagName?this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit):this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert);this.opts.activeButtonsAdd&&(b.each(this.opts.activeButtonsAdd,b.proxy(function(a,c){this.opts.activeButtons.push(c)},this)),b.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd));
b.each(this.opts.activeButtonsStates,b.proxy(function(a,c){0!=b(d).closest(a,this.$editor.get()[0]).length&&this.buttonActive(c)},this));var e=b(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(e.length)switch(e.css("text-align")){case "right":this.buttonActive("alignright");break;case "center":this.buttonActive("aligncenter");break;case "justify":this.buttonActive("justify");break;default:this.buttonActive("alignleft")}}},exec:function(a,c,b){"formatblock"===a&&this.browser("msie")&&
(c="<"+c+">");"inserthtml"===a&&this.browser("msie")?(this.$editor.focus(),this.document.selection.createRange().pasteHTML(c)):this.document.execCommand(a,!1,c);!1!==b&&this.sync();this.callback("execCommand",a,c)},execCommand:function(a,c,d){if(!this.opts.visual)return this.$source.focus(),!1;if("inserthtml"===a)this.insertHtml(c,d),this.callback("execCommand",a,c);else{if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre)return!1;if("insertunorderedlist"===a||"insertorderedlist"===a){this.bufferSet();
var e=this.getParent();d=b(e).closest("ol, ul");e=!1;if(d.length){var e=!0,f=d[0].tagName;if("insertunorderedlist"===a&&"OL"===f||"insertorderedlist"===a&&"UL"===f)e=!1}this.selectionSave();if(e){e=this.getNodes();d=this.getBlocks(e);"undefined"!=typeof e[0]&&(1<e.length&&3==e[0].nodeType)&&d.unshift(this.getBlock());var g="",h="";b.each(d,b.proxy(function(a,c){if("LI"==c.tagName){var d=b(c),e=d.clone();e.find("ul","ol").remove();g=!1===this.opts.linebreaks?g+this.outerHtml(b("<p>").append(e.contents())):
g+(e.html()+"<br>");0==a?(d.addClass("redactor-replaced").empty(),h=this.outerHtml(d)):d.remove()}},this));html=this.$editor.html().replace(h,"</"+f+">"+g+"<"+f+">");this.$editor.html(html);this.$editor.find(f+":empty").remove()}else this.document.execCommand(a),e=this.getParent(),d=b(e).parents("ol, ul"),d.length&&((this.browser("msie")||this.browser("mozilla"))&&"LI"!==e.tagName&&b(e).replaceWith(b(e).html()),f=d.parent(),this.isParentRedactor(f)&&this.nodeTestBlocks(f[0])&&f.replaceWith(f.contents())),
this.browser("mozilla")&&this.$editor.focus();this.selectionRestore();this.sync();this.callback("execCommand",a,c)}else{if("unlink"===a&&(this.bufferSet(),(e=this.getParent())&&"A"===b(e)[0].tagName)){b(e).replaceWith(b(e).text());this.sync();this.callback("execCommand",a,c);return}this.exec(a,c,d);"inserthorizontalrule"===a&&this.$editor.find("hr").removeAttr("id")}}},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(a){this.bufferSet();
if("indent"===a)if(a=this.getBlock(),this.selectionSave(),a&&"LI"==a.tagName){a=this.getParent();var c=b(a).closest("ol, ul")[0].tagName,d=this.getBlocks();b.each(d,function(a,d){if("LI"==d.tagName){var g=b(d).prev();if(0!=g.size()&&"LI"==g[0].tagName){var h=g.children("ul, ol");0==h.size()?g.append(b("<"+c+">").append(d)):h.append(d)}}})}else!1===a&&!0===this.opts.linebreaks?(this.exec("formatBlock","blockquote"),d=this.getBlock(),a=b('<div data-tagblock="">').html(b(d).html()),b(d).replaceWith(a),
d=this.normalize(b(a).css("margin-left"))+this.opts.indentValue,b(a).css("margin-left",d+"px")):(a=this.getBlocks(),b.each(a,b.proxy(function(a,c){var d=!1,d=-1!==b.inArray(c.tagName,this.opts.alignmentTags)?b(c):b(c).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),h=this.normalize(d.css("margin-left"))+this.opts.indentValue;d.css("margin-left",h+"px")},this)));else this.selectionSave(),(a=this.getBlock())&&"LI"==a.tagName?(d=this.getBlocks(),this.insideOutdent(a,0,d)):(a=
this.getBlocks(),b.each(a,b.proxy(function(a,c){var d=!1,d=-1!==b.inArray(c.tagName,this.opts.alignmentTags)?b(c):b(c).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),h=this.normalize(d.css("margin-left"))-this.opts.indentValue;0>=h?!0===this.opts.linebreaks&&"undefined"!==typeof d.data("tagblock")?d.replaceWith(d.html()):(d.css("margin-left",""),this.removeEmptyAttr(d,"style")):d.css("margin-left",h+"px")},this)));this.selectionRestore()},insideOutdent:function(a,c,d){if(a&&
"LI"==a.tagName){var e=b(a).parent().parent();0!=e.size()&&"LI"==e[0].tagName?e.after(a):"undefined"!=typeof d[c]?(a=d[c],c++,this.insideOutdent(a,c,d)):this.execCommand("insertunorderedlist")}},cleanEmpty:function(a){var c=this.placeholderStart(a);if(!1!==c)return c;!1===this.opts.linebreaks&&(""===a?a=this.opts.emptyHtml:-1!==a.search(/^<hr\s?\/?>$/gi)&&(a="<hr>"+this.opts.emptyHtml));return a},cleanConverters:function(a){this.opts.convertDivs&&(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>"));
this.opts.paragraphy&&(a=this.cleanParagraphy(a));return a},cleanConvertProtected:function(a){a=a.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');a=a.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>');a=a.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');return a=this.opts.phpTags?a.replace(/<\?php([\w\W]*?)\?>/gi,
'<section style="display: none;" rel="redactor-php-tag">$1</section>'):a.replace(/<\?php([\w\W]*?)\?>/gi,"")},cleanReConvertProtected:function(a){a=a.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2\x3c/script>');a=a.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>");a=a.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,
"<form$1$2>$3</form>");this.opts.phpTags&&(a=a.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>"));return a},cleanRemoveSpaces:function(a,c){if(!1!==c){c=[];var d=0,e;e=a.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);null!==e&&b.each(e,function(b,e){d=b;a=a.replace(e,"buffer_"+d);c.push(e)});this.opts.phpTags&&(e=a.match(/<\?php([\w\W]*?)\?>/gi),null!==e&&b.each(e,function(b,e){d+=b;a=a.replace(e,"buffer_"+
b);c.push(e)}))}a=a.replace(/\n/g," ");a=a.replace(/[\t]*/g,"");a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/g," ");a=a.replace(/[\s\n]*$/g," ");a=a.replace(/>\s{2,}</g,"><");!1!==c&&(a=this.cleanReplacer(c,a));return a=a.replace(/\n\n/g,"\n")},cleanReplacer:function(a,c){a&&b.each(a,function(a,b){c=c.replace("buffer_"+a,b)});return c},cleanRemoveEmptyTags:function(a){a=a.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/[\u200B-\u200D\uFEFF]/g,"");for(var c=["<b>\\s*</b>","<b>&nbsp;</b>",
"<em>\\s*</em>"],b="<pre></pre> <blockquote>\\s*</blockquote> <dd></dd> <dt></dt> <ul></ul> <ol></ol> <li></li> <table></table> <tr></tr> <span>\\s*<span> <span>&nbsp;<span> <p>\\s*</p> <p></p> <p>&nbsp;</p> <p>\\s*<br>\\s*</p> <div>\\s*</div> <div>\\s*<br>\\s*</div>".split(" "),b=this.opts.removeEmptyTags?b.concat(c):c,c=b.length,e=0;e<c;++e)a=a.replace(RegExp(b[e],"gi"),"");return a},cleanParagraphy:function(a){function c(c,b,d){return a.replace(RegExp(c,b),d)}a=b.trim(a);if(!0===this.opts.linebreaks)return a;
if(""===a||"<p></p>"===a)return this.opts.emptyHtml;a+="\n";var d=[],e=0,f=a.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);f&&b.each(f,function(c,b){e++;d[e]=b;a=a.replace(b,"{replace"+e+"}\n")});this.opts.phpTags&&(f=a.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi))&&b.each(f,function(c,b){e++;d[e]=b;a=a.replace(b,"{replace"+e+"}\n")});a=a.replace(/<\!\-\-([\w\W]*?)\-\->/gi,"<comment>$1</comment>");a=a.replace(/<br \/>\s*<br \/>/gi,"\n\n");a=c("(<(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)",
"gi","\n$1");a=c("(</(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)>)","gi","$1\n\n");a=c("\r\n","g","\n");a=c("\r","g","\n");a=c("/\n\n+/","g","\n\n");f=a.split(RegExp("\ns*\n","g"),-1);a="";for(var g in f)f.hasOwnProperty(g)&&(a=-1==
f[g].search("{replace")?a+("<p>"+f[g].replace(/^\n+|\n+$/g,"")+"</p>"):a+f[g]);-1!==a.search(/<blockquote/gi)&&b.each(a.match(/<blockquote(.*?)>([\w\W]*?)<\/blockquote>/gi),function(c,b){var d="",d=b.replace("<p>",""),d=d.replace("</p>","<br>");a=a.replace(b,d)});a=c("<p>s*</p>","gi","");a=c("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");a=c("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=c("<p>(<li.+?)</p>","gi","$1");a=c("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)","gi","$1");a=c("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=c("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*<br />","gi","$1");a=c("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");a=c("\n</p>","gi","</p>");a=c("</li><p>","gi","</li>");a=c("</ol><p>",
"gi","</ol>");a=c("<p>\t?\n?<p>","gi","<p>");a=c("</dt><p>","gi","</dt>");a=c("</dd><p>","gi","</dd>");a=c("<br></p></blockquote>","gi","</blockquote>");a=c("<p>    </p>","gi","");b.each(d,function(c,b){a=a.replace("{replace"+c+"}",b)});a=a.replace(/<comment>([\w\W]*?)<\/comment>/gi,"\x3c!--$1--\x3e");return b.trim(a)},cleanConvertInlineTags:function(a){var c="strong";"b"===this.opts.boldTag&&(c="b");var b="em";"i"===this.opts.italicTag&&(b="i");a=a.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,
"<"+b+">$1</"+b+">");a=a.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+c+">$1</"+c+">");a="strong"===this.opts.boldTag?a.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>"):a.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>");a="em"===this.opts.italicTag?a.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>"):a.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>");a=a.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>");/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi.test(a)||
(a=a.replace(/<span(.*?)(?!data-redactor="verified")(.*?)>([\w\W]*?)<\/span>/gi,'<span$1 data-redactor="verified"$2>$3</span>'));return a},cleanStripTags:function(a){if(""==a||"undefined"==typeof a)return a;var c=!1;!1!==this.opts.allowedTags&&(c=!0);var d=!0===c?this.opts.allowedTags:this.opts.deniedTags;a=a.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,f){return!0===c?"-1"<b.inArray(f.toLowerCase(),d)?a:"":"-1"<b.inArray(f.toLowerCase(),d)?"":a});return a=this.cleanConvertInlineTags(a)},cleanSavePreCode:function(a,
c){var d=a.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);null!==d&&b.each(d,b.proxy(function(b,d){var g=d.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);g[3]=g[3].replace(/&nbsp;/g," ");!1!==c&&(g[3]=this.cleanEncodeEntities(g[3]));a=a.replace(d,"<"+g[1]+g[2]+">"+g[3]+"</"+g[1]+">")},this));return a},cleanEncodeEntities:function(a){a=String(a).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,
"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var a=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");a.filter('[style*="font-size"][style*="line-height"]').css("font-size","").css("line-height","");a.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");a.filter('[style*="background-color: transparent;"]').css("background-color","");a.css("line-height","");b.each(a,b.proxy(function(a,
b){this.removeEmptyAttr(b,"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(a){var c=0,b=a.length,e=0,f=null,e=null,g="",h="",g="";for(this.cleanlevel=0;c<b;c++){e=c;if(-1==a.substr(c).indexOf("<")){h+=a.substr(c);break}for(;e<b&&"<"!=a.charAt(e);)e++;c!=e&&(g=a.substr(c,e-c),g.match(/^\s{2,}$/g)||("\n"==h.charAt(h.length-1)?h+=this.cleanGetTabs():"\n"==g.charAt(0)&&(h+="\n"+this.cleanGetTabs(),g=g.replace(/^\s+/,"")),h+=g),g.match(/\n/)&&
(h+="\n"+this.cleanGetTabs()));for(f=e;e<b&&">"!=a.charAt(e);)e++;g=a.substr(f,e-f);c=e;if("!--"==g.substr(1,3)){if(!g.match(/--$/)){for(;"--\x3e"!=a.substr(e,3);)e++;e+=2;g=a.substr(f,e-f);c=e}"\n"!=h.charAt(h.length-1)&&(h+="\n");h+=this.cleanGetTabs();h+=g+">\n"}else if("!"==g[1])h=this.placeTag(g+">",h);else if("?"==g[1])h+=g+">\n";else if(e=g.match(/^<(script|style|pre)/i)){if(e[1]=e[1].toLowerCase(),g=this.cleanTag(g),h=this.placeTag(g,h),e=String(a.substr(c+1)).toLowerCase().indexOf("</"+e[1]))g=
a.substr(c+1,e),c+=e,h+=g}else g=this.cleanTag(g),h=this.placeTag(g,h)}return this.cleanFinish(h)},cleanGetTabs:function(){for(var a="",c=0;c<this.cleanlevel;c++)a+="\t";return a},cleanFinish:function(a){a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/,"");a=a.replace(/[\s\n]*$/,"");a=a.replace(/<script(.*?)>\n<\/script>/gi,"<script$1>\x3c/script>");this.cleanlevel=0;return a},cleanTag:function(a){var c="";a=a.replace(/\n/g," ");a=a.replace(/\s{2,}/g," ");a=a.replace(/^\s+|\s+$/g," ");var b="";
a.match(/\/$/)&&(b="/",a=a.replace(/\/+$/,""));for(var e;e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(a);)e[2]?c+=e[1].toLowerCase()+"="+e[2]:e[1]&&(c+=e[1].toLowerCase()),c+=" ",a=a.substr(e[0].length);return c.replace(/\s*$/,"")+b+">"},placeTag:function(a,c){var b=a.match(this.cleannewLevel);if(a.match(this.cleanlineBefore)||b)c=c.replace(/\s*$/,""),c+="\n";b&&"/"==a.charAt(1)&&this.cleanlevel--;"\n"==c.charAt(c.length-1)&&(c+=this.cleanGetTabs());b&&"/"!=a.charAt(1)&&this.cleanlevel++;c+=a;if(a.match(this.cleanlineAfter)||
a.match(this.cleannewLevel))c=c.replace(/ *$/,""),c+="\n";return c},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(a,c){this.bufferSet();if(this.oldIE())return this.document.execCommand(c,!1,!1),!0;this.selectionSave();var d=this.getBlock();if(!d&&this.opts.linebreaks){this.exec("formatBlock",
"blockquote");var e=this.getBlock(),d=b('<div data-tagblock="">').html(b(e).html());b(e).replaceWith(d);b(d).css("text-align",a);this.removeEmptyAttr(d,"style");""==a&&"undefined"!==typeof b(d).data("tagblock")&&b(d).replaceWith(b(d).html())}else d=this.getBlocks(),b.each(d,b.proxy(function(c,d){var e=!1;if(e=-1!==b.inArray(d.tagName,this.opts.alignmentTags)?b(d):b(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]))e.css("text-align",a),this.removeEmptyAttr(e,"style")},this));
this.selectionRestore();this.sync()},formatEmpty:function(a){var c=b.trim(this.$editor.html()),c=c.replace(/<br\s?\/?>/i,""),d=c.replace(/<p>\s?<\/p>/gi,"");if(""===c||""===d)a.preventDefault(),a=b(this.opts.emptyHtml).get(0),this.$editor.html(a),this.focus();this.sync()},formatBlocks:function(a){this.bufferSet();var c=this.getBlocks();this.selectionSave();b.each(c,b.proxy(function(c,b){"LI"!==b.tagName&&this.formatBlock(a,b)},this));this.selectionRestore();this.sync()},formatBlock:function(a,c){!1===
c&&(c=this.getBlock());if(!1===c)return!0===this.opts.linebreaks&&this.execCommand("formatblock",a),!0;var d="";"pre"!==a?d=b(c).contents():(d=b(c).html(),""===b.trim(d)&&(d='<span id="selection-marker-1"></span>'));"PRE"===c.tagName&&(a="p");!0===this.opts.linebreaks&&"p"===a?b(c).replaceWith(b("<div>").append(d).html()+"<br>"):(d=b("<"+a+">").append(d),b(c).replaceWith(d))},formatChangeTag:function(a,c,d){!1!==d&&this.selectionSave();var e=b("<"+c+"/>");b(a).replaceWith(function(){return e.append(b(this).contents())});
!1!==d&&this.selectionRestore();return e},formatQuote:function(){this.bufferSet();if(!1===this.opts.linebreaks){this.selectionSave();var a=this.getBlocks();a&&b.each(a,b.proxy(function(a,c){"BLOCKQUOTE"===c.tagName?this.formatBlock("p",c,!1):"LI"!==c.tagName&&this.formatBlock("blockquote",c,!1)},this));this.selectionRestore()}else if(a=this.getBlock(),"BLOCKQUOTE"===a.tagName)this.selectionSave(),b(a).replaceWith(b(a).html()+"<br>"),this.selectionRestore();else{var a=this.selectionWrap("blockquote"),
c=b(a).html();b.each("ul ol table tr tbody thead tfoot dl".split(" "),function(a,b){c=c.replace(RegExp("<"+b+"(.*?)>","gi"),"");c=c.replace(RegExp("</"+b+">","gi"),"")});var d=this.opts.blockLevelElements;d.push("td");b.each(d,function(a,b){c=c.replace(RegExp("<"+b+"(.*?)>","gi"),"");c=c.replace(RegExp("</"+b+">","gi"),"<br>")});b(a).html(c);this.selectionElement(a);a=b(a).next();"BR"===a[0].tagName&&a.remove()}this.sync()},blockRemoveAttr:function(a,c){var d=this.getBlocks();b(d).removeAttr(a);this.sync()},
blockSetAttr:function(a,c){var d=this.getBlocks();b(d).attr(a,c);this.sync()},blockRemoveStyle:function(a){var c=this.getBlocks();b(c).css(a,"");this.removeEmptyAttr(c,"style");this.sync()},blockSetStyle:function(a,c){var d=this.getBlocks();b(d).css(a,c);this.sync()},blockRemoveClass:function(a){var c=this.getBlocks();b(c).removeClass(a);this.removeEmptyAttr(c,"class");this.sync()},blockSetClass:function(a){var c=this.getBlocks();b(c).addClass(a);this.sync()},inlineRemoveClass:function(a){this.selectionSave();
this.inlineEachNodes(function(c){b(c).removeClass(a);this.removeEmptyAttr(c,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(a){var c=this.getCurrent();b(c).hasClass(a)||this.inlineMethods("addClass",a)},inlineRemoveStyle:function(a){this.selectionSave();this.inlineEachNodes(function(c){b(c).css(a,"");this.removeEmptyAttr(c,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(a,c){this.inlineMethods("css",a,c)},inlineRemoveAttr:function(a){this.selectionSave();
var c=this.getRange(),d=this.getElement(),e=this.getNodes();if(c.collapsed||c.startContainer===c.endContainer&&d)e=b(d);b(e).removeAttr(a);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(a,c){this.inlineMethods("attr",a,c)},inlineMethods:function(a,c,d){this.bufferSet();this.selectionSave();var e=this.getRange(),f=this.getElement();if(e.collapsed||e.startContainer===e.endContainer&&f)b(f)[a](c,d);else this.document.execCommand("fontSize",!1,4),e=this.$editor.find("font"),
b.each(e,b.proxy(function(b,e){this.inlineSetMethods(a,e,c,d)},this));this.selectionRestore();this.sync()},inlineSetMethods:function(a,c,d,e){var f=b(c).parent();f&&"SPAN"===f[0].tagName&&0!=f[0].attributes.length?b(c).replaceWith(b(c).html()):(f=b('<span data-redactor="verified" data-redactor-inlineMethods>').append(b(c).contents()),b(c).replaceWith(f));b(f)[a](d,e);return f},inlineEachNodes:function(a){var c=this.getRange(),d=this.getElement(),e=this.getNodes(),f;if(c.collapsed||c.startContainer===
c.endContainer&&d)e=b(d),f=!0;b.each(e,b.proxy(function(c,d){if(!f&&"SPAN"!==d.tagName){if("SPAN"!==d.parentNode.tagName||b(d.parentNode).hasClass("redactor_editor"))return;d=d.parentNode}a.call(this,d)},this))},inlineUnwrapSpan:function(){var a=this.$editor.find("span[data-redactor-inlineMethods]");b.each(a,b.proxy(function(a,d){var e=b(d);void 0===e.attr("class")&&void 0===e.attr("style")&&e.contents().unwrap()},this))},inlineFormat:function(a){this.selectionSave();this.document.execCommand("fontSize",
!1,4);var c=this.$editor.find("font");b.each(c,function(c,e){var f=b("<"+a+"/>").append(b(e).contents());b(e).replaceWith(f)});this.selectionRestore();this.sync()},inlineRemoveFormat:function(a){this.selectionSave();var c=a.toUpperCase();a=this.getNodes();b.each(a,function(a,e){e.tagName===c&&b(e).replaceWith(b(e).contents())});this.selectionRestore();this.sync()},insertHtml:function(a,c){var d=this.getCurrent(),e=d.parentNode;this.$editor.focus();this.bufferSet();var f=b("<div>").append(a);a=f.html();
a=this.cleanRemoveEmptyTags(a);var f=b("<div>").append(a),g=this.getBlock();if(1==f.contents().length){var h=f.contents()[0].tagName;if("P"!=h&&h==g.tagName||"PRE"==h)a=f.text(),f=b("<div>").append(a)}!this.opts.linebreaks&&(1==f.contents().length&&3==f.contents()[0].nodeType&&(2<this.getRangeSelectedNodes().length||!d||"BODY"==d.tagName&&!e||"HTML"==e.tagName))&&(a="<p>"+a+"</p>");"BLOCKQUOTE"==g.tagName&&-1===a.indexOf("<a")?this.insertText(a):1<f.contents().length&&g||f.contents().is("p, :header, ul, ol, div, table, blockquote, pre, address, section, header, footer, aside, article")?
this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a):this.insertHtmlAdvanced(a);this.selectall&&this.window.setTimeout(b.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1);this.observeStart();!1!==c&&this.sync()},insertHtmlAdvanced:function(a){var c=this.getSelection();if(c.getRangeAt&&c.rangeCount){var b=c.getRangeAt(0);b.deleteContents();var e=this.document.createElement("div");
e.innerHTML=a;a=this.document.createDocumentFragment();for(var f,g;f=e.firstChild;)g=a.appendChild(f);b.insertNode(a);g&&(b=b.cloneRange(),b.setStartAfter(g),b.collapse(!0),c.removeAllRanges(),c.addRange(b))}},insertText:function(a){var c=b(a);c.length&&(a=c.text());this.$editor.focus();this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a);this.sync()},insertNode:function(a){a=a[0]||a;var c=this.getSelection();c.getRangeAt&&c.rangeCount&&
(range=c.getRangeAt(0),range.deleteContents(),range.insertNode(a),range.setEndAfter(a),range.setStartAfter(a),c.removeAllRanges(),c.addRange(range))},insertAfterLastElement:function(a){if(this.isEndOfElement()){if(this.$editor.contents().last()[0]!==a)return!1;this.bufferSet();if(!1===this.opts.linebreaks){var c=b(this.opts.emptyHtml);b(a).after(c);this.selectionStart(c)}else c=b('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0],b(a).after(c),b(c).after(this.opts.invisibleSpace),
this.selectionRestore()}},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(a){var c=b("<br>"+this.opts.invisibleSpace);b(a).replaceWith(c);this.selectionStart(c)},
pasteClean:function(a){a=this.callback("pasteBefore",!1,a);if(this.currentOrParentIs("PRE"))return a=this.pastePre(a),this.pasteInsert(a),!0;a=a.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><p$2</p>");a=a.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<p$2</p></ul>");a=a.replace(/\x3c!--[\s\S]*?--\x3e|<\?(?:php)?[\s\S]*?\?>/gi,"");a=a.replace(/(&nbsp;){2,}/gi,"&nbsp;");a=a.replace(/&nbsp;/gi," ");a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,
"$2");a=this.cleanStripTags(a);a=a.replace(/<td><\/td>/gi,"[td]");a=a.replace(/<td>&nbsp;<\/td>/gi,"[td]");a=a.replace(/<td><br><\/td>/gi,"[td]");a=a.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');a=a.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");a=a.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");a=a.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");a=a.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");
a=a.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");a=a.replace(/<param(.*?)>/gi,"[param$1]");a=a.replace(/<img(.*?)style="(.*?)"(.*?)>/gi,"[img$1$3]");a=a.replace(/ class="(.*?)"/gi,"");a=a.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");a=a.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");a=a.replace(/\[td\]/gi,"<td>&nbsp;</td>");a=a.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');a=a.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,
"<iframe$1>$2</iframe>");a=a.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");a=a.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");a=a.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");a=a.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");a=a.replace(/\[param(.*?)\]/gi,"<param$1>");a=a.replace(/\[img(.*?)\]/gi,"<img$1>");this.opts.convertDivs&&(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>"),a=a.replace(/<\/div><p>/gi,
"<p>"),a=a.replace(/<\/p><\/div>/gi,"</p>"));a=this.cleanParagraphy(a);a=a.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");a=a.replace(/<img>/gi,"");a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/\n{3,}/gi,"\n");a=a.replace(/<p><p>/gi,"<p>");a=a.replace(/<\/p><\/p>/gi,"</p>");a=a.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");a=a.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");!0===this.opts.linebreaks&&(a=a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));
a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");if(this.browser("mozilla"))for(;/<br>$/gi.test(a);)a=a.replace(/<br>$/gi,"");for(a=a.replace(/<p>\u2022([\w\W]*?)<\/p>/gi,"<li>$1</li>");/<font>([\w\W]*?)<\/font>/gi.test(a);)a=a.replace(/<font>([\w\W]*?)<\/font>/gi,"$1");this.pasteInsert(a)},pastePre:function(a){a=a.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var c=this.document.createElement("div");c.innerHTML=a;return this.cleanEncodeEntities(c.textContent||
c.innerText)},pasteInsert:function(a){this.selectall&&(this.opts.linebreaks?this.$editor.html(""):this.$editor.html(this.opts.emptyHtml),this.$editor.focus());a=this.callback("pasteAfter",!1,a);this.insertHtml(a);this.selectall=!1;setTimeout(function(){n=!1},100);this.opts.autoresize?b(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},bufferSet:function(a){void 0!==a?this.opts.buffer.push(a):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRemoveMarkers("buffer"))},
bufferUndo:function(){0===this.opts.buffer.length?this.$editor.focus():(this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout(b.proxy(this.observeStart,this),100))},bufferRedo:function(){if(0===this.opts.rebuffer.length)return this.$editor.focus(),!1;this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(!1,!0);this.$editor.html(this.opts.rebuffer.pop());
this.selectionRestore(!0);setTimeout(b.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();this.observeTables()},observeTables:function(){this.$editor.find("table").on("click",b.proxy(this.tableObserver,this))},observeImages:function(){if(!1===this.opts.observeImages)return!1;this.$editor.find("img").each(b.proxy(function(a,c){this.browser("msie")&&b(c).attr("unselectable","on");this.imageResize(c)},this))},getSelection:function(){return this.opts.rangy?this.opts.iframe?
rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var a=this.document.getSelection();if(a.getRangeAt&&a.rangeCount)return a.getRangeAt(0)}return this.document.createRange()},selectionElement:function(a){this.setCaret(a)},selectionStart:function(a){this.selectionSet(a[0]||a,0,null,0)},selectionEnd:function(a){this.selectionSet(a[0]||
a,1,null,1)},selectionSet:function(a,c,b,e){null==b&&(b=a);null==e&&(e=c);var f=this.getSelection();if(f){var g=this.getRange();g.setStart(a,c);g.setEnd(b,e);try{f.removeAllRanges()}catch(h){}f.addRange(g)}},selectionWrap:function(a){a=a.toLowerCase();var c=this.getBlock();if(c)return a=this.formatChangeTag(c,a),this.sync(),a;c=this.getSelection().getRangeAt(0);a=document.createElement(a);a.appendChild(c.extractContents());c.insertNode(a);this.selectionElement(a);return a},selectionAll:function(){var a=
this.getRange();a.selectNodeContents(this.$editor[0]);var c=this.getSelection();c.removeAllRanges();c.addRange(a)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(a){var c=0,c=this.getSelection().getRangeAt(0),d=c.cloneRange();d.selectNodeContents(a);d.setEnd(c.endContainer,c.endOffset);return c=b.trim(d.toString()).length},getCaretOffsetRange:function(){return new p(this.getSelection().getRangeAt(0))},setCaret:function(a,c,b){"undefined"===typeof b&&(b=c);
a=a[0]||a;var e=this.getRange();e.selectNodeContents(a);a=this.getTextNodesIn(a);var f=!1,g=0,h;if(1==a.length&&c)e.setStart(a[0],c),e.setEnd(a[0],b);else for(var k=0,l;l=a[k++];){h=g+l.length;!f&&(c>=g&&(c<h||c==h&&k<a.length))&&(e.setStart(l,c-g),f=!0);if(f&&b<=h){e.setEnd(l,b-g);break}g=h}c=this.getSelection();c.removeAllRanges();c.addRange(e)},getTextNodesIn:function(a){var c=[];if(3==a.nodeType)c.push(a);else{a=a.childNodes;for(var b=0,e=a.length;b<e;++b)c.push.apply(c,this.getTextNodesIn(a[b]))}return c},
selectionSave:function(){this.isFocused()||this.$editor.focus();this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(a,c){if(a){var d=b('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0],e=b('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];!0===a.collapsed?this.selectionSetMarker(a,d,!0):
(this.selectionSetMarker(a,d,!0),this.selectionSetMarker(a,e,!1));this.savedSel=this.$editor.html();this.selectionRestore(!1,!1)}},selectionSetMarker:function(a,c,b){a=a.cloneRange();a.collapse(b);a.insertNode(c);a.detach()},selectionRestore:function(a,c){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{!0===a&&this.savedSel&&this.$editor.html(this.savedSel);var b=this.$editor.find("span#selection-marker-1"),e=this.$editor.find("span#selection-marker-2");this.isFocused()||this.$editor.focus();
0!=b.length&&0!=e.length?this.selectionSet(b[0],0,e[0],0):0!=b.length&&this.selectionSet(b[0],0,null,0);!1!==c&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(a){this.opts.rangy?rangy.removeMarkers(this.savedSel):b.each(this.$editor.find("span.redactor-selection-marker"),function(){""==b.trim(b(this).html().replace(/[^\u0000-~]/g,""))?b(this).remove():b(this).removeAttr("class").removeAttr("id")})},getCurrent:function(){var a=!1,c=this.getSelection();0<c.rangeCount&&
(a=c.getRangeAt(0).startContainer);return this.isParentRedactor(a)},getParent:function(a){return(a=a||this.getCurrent())?this.isParentRedactor(b(a).parent()[0]):!1},getBlock:function(a){for("undefined"===typeof a&&(a=this.getCurrent());a;){if(this.nodeTestBlocks(a)){if(b(a).hasClass("redactor_editor"))break;return a}a=a.parentNode}return!1},getBlocks:function(a){var c=[];if("undefined"==typeof a){if((a=this.getRange())&&!0===a.collapsed)return[this.getBlock()];a=this.getNodes(a)}b.each(a,b.proxy(function(a,
e){if(!1===this.opts.iframe&&0==b(e).parents("div.redactor_editor").size())return!1;this.nodeTestBlocks(e)&&c.push(e)},this));0===c.length&&(c=[this.getBlock()]);return c},nodeTestBlocks:function(a){return 1==a.nodeType&&this.rTestBlock.test(a.nodeName)},tagTestBlock:function(a){return this.rTestBlock.test(a)},getSelectedNodes:function(a){if("undefined"==typeof a||!1==a)a=this.getRange();if(a&&!0===a.collapsed)return[this.getCurrent()];a=this.getSelection();try{var c=a.getRangeAt(0).cloneContents()}catch(b){return!1}a=
this.document.createElement("span");a.appendChild(c);window.selnodes=a.childNodes;c=[];a=0;for(var e=selnodes.length;a<e;a++)c.push(selnodes[a]);0==c.length&&c.push(this.getCurrent());return c},getNodes:function(a,c){if(this.opts.linebreaks)return this.getSelectedNodes(a);if("undefined"==typeof a||!1==a)a=this.getRange();if(a&&!0===a.collapsed){if("undefined"===typeof c&&this.tagTestBlock(c)){var d=this.getBlock();return d.tagName==c?[d]:[]}return[this.getCurrent()]}var d=[],e=[],f=this.document.getSelection();
f.isCollapsed||(d=this.getRangeSelectedNodes(f.getRangeAt(0)));b.each(d,b.proxy(function(a,d){if(!1===this.opts.iframe&&0==b(d).parents("div.redactor_editor").size())return!1;"undefined"===typeof c?""!=b.trim(d.textContent)&&e.push(d):d.tagName==c&&e.push(d)},this));if(0==e.length){if("undefined"===typeof c&&this.tagTestBlock(c))return d=this.getBlock(),d.tagName==c?e.push(d):[];e.push(this.getCurrent())}return e},getElement:function(a){for(a||(a=this.getCurrent());a;){if(1==a.nodeType){if(b(a).hasClass("redactor_editor"))break;
return a}a=a.parentNode}return!1},getRangeSelectedNodes:function(a){a=a||this.getRange();var c=a.startContainer,b=a.endContainer;if(c==b)return[c];for(var e=[];c&&c!=b;)e.push(c=this.nextNode(c));for(c=a.startContainer;c&&c!=a.commonAncestorContainer;)e.unshift(c),c=c.parentNode;return e},nextNode:function(a){if(a.hasChildNodes())return a.firstChild;for(;a&&!a.nextSibling;)a=a.parentNode;return a?a.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var a=
"",c=this.getSelection();if(c.rangeCount){for(var a=this.document.createElement("div"),b=c.rangeCount,e=0;e<b;++e)a.appendChild(c.getRangeAt(e).cloneContents());a=a.innerHTML}return this.syncClean(a)},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,b.proxy(function(){b("#redactor_insert_table_btn").click(b.proxy(this.tableInsert,this));setTimeout(function(){b("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var a=b("#redactor_table_rows").val(),
c=b("#redactor_table_columns").val(),d=b("<div></div>"),e=Math.floor(99999*Math.random()),f=b('<table id="table'+e+'"><tbody></tbody></table>'),g,h,k,l;for(g=0;g<a;g++){h=b("<tr></tr>");for(k=0;k<c;k++)l=b("<td>"+this.opts.invisibleSpace+"</td>"),0===g&&0===k&&l.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),b(h).append(l);f.append(h)}d.append(f);a=d.html();this.modalClose();this.selectionRestore();(c=this.getBlock()||this.getCurrent())?b(c).after(a):this.insertHtmlAdvanced(a);
this.selectionRestore();e=this.$editor.find("#table"+e);this.tableObserver(e);this.buttonActiveObserver();e.removeAttr("id");this.sync()},tableObserver:function(a){this.$table=b(a.target||a).closest("table");this.$tbody=b(a.target).closest("tbody");this.$thead=this.$table.find("thead");this.$current_td=b(a.target||this.$table.find("td").first());this.$current_tr=b(a.target||this.$table.find("tr").first()).closest("tr")},tableDeleteTable:function(){this.bufferSet();this.$table&&(this.$table.remove(),
this.$table=!1,this.sync())},tableDeleteRow:function(){this.bufferSet();if(this.$current_tr){var a=this.$current_tr.prev().length?this.$current_tr.prev():this.$current_tr.next();a.length&&(a=a.children("td").first(),a.length&&(a.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore()));this.$current_tr.remove();this.sync()}},tableDeleteColumn:function(){this.bufferSet();var a=this.$current_td.get(0).cellIndex;this.$table.find("tr").each(b.proxy(function(c,
d){var e=0>a-1?a+1:a-1;0===c&&(b(d).find("td").eq(e).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore());b(d).find("td").eq(a).remove()},this));this.sync()},tableAddHead:function(){this.bufferSet();if(0!==this.$table.find("thead").size())this.tableDeleteHead();else{var a=this.$table.find("tr").first().clone();a.find("td").html(this.opts.invisibleSpace);this.$thead=b("<thead></thead>");this.$thead.append(a);this.$table.prepend(this.$thead);this.sync()}},
tableDeleteHead:function(){this.bufferSet();b(this.$thead).remove();this.$thead=!1;this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(a){this.bufferSet();var c=this.$current_tr.clone();c.find("td").html(this.opts.invisibleSpace);"after"===a?this.$current_tr.after(c):this.$current_tr.before(c);
this.sync()},tableAddColumn:function(a){this.bufferSet();var c=0;this.$current_tr.find("td").each(b.proxy(function(a,e){b(e)[0]===this.$current_td[0]&&(c=a)},this));this.$table.find("tr").each(b.proxy(function(d,e){var f=b(e).find("td").eq(c),g=f.clone();g.html(this.opts.invisibleSpace);"after"===a?f.after(g):f.before(g)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,b.proxy(function(){b("#redactor_insert_video_btn").click(b.proxy(this.videoInsert,
this));setTimeout(function(){b("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var a=b("#redactor_insert_video_area").val(),a=this.cleanStripTags(a);this.selectionRestore();var c=this.getBlock()||this.getCurrent();c?(b(c).after(a),this.sync()):this.insertHtmlAdvanced(a);this.modalClose()},linkShow:function(){this.selectionSave();var a=b.proxy(function(){this.insert_link_node=!1;var a=this.getSelection(),d="",e="",f="",g=this.getParent();(e=b(g).parent().get(0))&&"A"===
e.tagName&&(g=e);g&&"A"===g.tagName?(d=g.href,e=b(g).text(),f=g.target,this.insert_link_node=g):e=a.toString();b(".redactor_link_text").val(e);a=self.location.href.replace(/\/$/i,"");a=d.replace(a,"");g=b("#redactor_tabs").find("a");!1===this.opts.linkEmail&&g.eq(1).remove();!1===this.opts.linkAnchor&&g.eq(2).remove();!1===this.opts.linkEmail&&!1===this.opts.linkAnchor?(b("#redactor_tabs").remove(),b("#redactor_link_url").val(a)):0===d.search("mailto:")?(this.modalSetTab.call(this,2),b("#redactor_tab_selected").val(2),
b("#redactor_link_mailto").val(d.replace("mailto:",""))):0===a.search(/^#/gi)?(this.modalSetTab.call(this,3),b("#redactor_tab_selected").val(3),b("#redactor_link_anchor").val(a.replace(/^#/gi,""))):b("#redactor_link_url").val(a);"_blank"===f&&b("#redactor_link_blank").prop("checked",!0);b("#redactor_insert_link_btn").click(b.proxy(this.linkProcess,this));setTimeout(function(){b("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,a)},linkProcess:function(){var a=
b("#redactor_tab_selected").val(),c="",d="",e="",f="";"1"===a?(c=b("#redactor_link_url").val(),d=b("#redactor_link_url_text").val(),b("#redactor_link_blank").prop("checked")&&(e=' target="_blank"',f="_blank"),a=/^((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i,-1==c.search(/^(http|ftp|https):\/\/((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i)&&(0==c.search(a)&&this.opts.linkProtocol)&&(c=this.opts.linkProtocol+c)):"2"===a?(c="mailto:"+b("#redactor_link_mailto").val(),d=b("#redactor_link_mailto_text").val()):
"3"===a&&(c="#"+b("#redactor_link_anchor").val(),d=b("#redactor_link_anchor_text").val());this.linkInsert('<a href="'+c+'"'+e+">"+d+"</a>",b.trim(d),c,f)},linkInsert:function(a,c,d,e){this.selectionRestore();""!==c&&(this.insert_link_node?(this.bufferSet(),b(this.insert_link_node).text(c).attr("href",d),""!==e?b(this.insert_link_node).attr("target",e):b(this.insert_link_node).removeAttr("target"),this.sync()):this.exec("inserthtml",a));this.modalClose()},fileShow:function(){this.selectionSave();var a=
b.proxy(function(){var a=this.getSelection(),d="",d=this.oldIE()?a.text:a.toString();b("#redactor_filename").val(d);this.isMobile()||this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:b.proxy(this.fileCallback,this),error:b.proxy(function(a,b){this.callback("fileUploadError",b)},this)});this.uploadInit("redactor_file",{auto:!0,url:this.opts.fileUpload,success:b.proxy(this.fileCallback,this),error:b.proxy(function(a,b){this.callback("fileUploadError",
b)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,a)},fileCallback:function(a){this.selectionRestore();if(!1!==a){var c=b("#redactor_filename").val();""===c&&(c=a.filename);c='<a href="'+a.filelink+'" id="filelink-marker">'+c+"</a>";this.browser("webkit")&&this.window.chrome&&(c+="&nbsp;");this.execCommand("inserthtml",c,!1);c=b(this.$editor.find("a#filelink-marker"));0!=c.size()?c.removeAttr("id"):c=!1;this.sync();this.callback("fileUpload",c,a)}this.modalClose()},
imageShow:function(){this.selectionSave();var a=b.proxy(function(){this.opts.imageGetJson?b.getJSON(this.opts.imageGetJson,b.proxy(function(a){var c={},f=0;b.each(a,b.proxy(function(a,b){"undefined"!==typeof b.folder&&(f++,c[b.folder]=f)},this));var g=!1;b.each(a,b.proxy(function(a,d){var f="";"undefined"!==typeof d.title&&(f=d.title);var h=0;b.isEmptyObject(c)||"undefined"===typeof d.folder||(h=c[d.folder],!1===g&&(g=".redactorfolder"+h));f=b('<img src="'+d.thumb+'" class="redactorfolder redactorfolder'+
h+'" rel="'+d.image+'" title="'+f+'" />');b("#redactor_image_box").append(f);b(f).click(b.proxy(this.imageThumbClick,this))},this));if(!b.isEmptyObject(c)){b(".redactorfolder").hide();b(g).show();var h=b('<select id="redactor_image_box_select">');b.each(c,function(a,c){h.append(b('<option value="'+c+'">'+a+"</option>"))});b("#redactor_image_box").before(h);h.change(function(a){b(".redactorfolder").hide();b(".redactorfolder"+b(a.target).val()).show()})}},this)):b("#redactor_tabs").find("a").eq(1).remove();
if(this.opts.imageUpload||this.opts.s3)if(this.isMobile()||!1!==this.opts.s3||b("#redactor_file").length&&this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:b.proxy(this.imageCallback,this),error:b.proxy(function(a,b){this.callback("imageUploadError",b)},this)}),!1===this.opts.s3)this.uploadInit("redactor_file",{auto:!0,url:this.opts.imageUpload,success:b.proxy(this.imageCallback,this),error:b.proxy(function(a,b){this.callback("imageUploadError",
b)},this)});else b("#redactor_file").on("change.redactor",b.proxy(this.s3handleFileSelect,this));else if(b(".redactor_tab").hide(),this.opts.imageGetJson){var a=b("#redactor_tabs").find("a");a.eq(0).remove();a.eq(1).addClass("redactor_tabs_act");b("#redactor_tab2").show()}else b("#redactor_tabs").remove(),b("#redactor_tab3").show();b("#redactor_upload_btn").click(b.proxy(this.imageCallbackLink,this));this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){b("#redactor_file_link").focus()},
200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,a)},imageEdit:function(a){var c=b(a.target),d=c.parent();a=b.proxy(function(){b("#redactor_file_alt").val(c.attr("alt"));b("#redactor_image_edit_src").attr("href",c.attr("src"));b("#redactor_form_image_align").val(c.css("float"));"A"===b(d).get(0).tagName&&b("#redactor_file_link").val(b(d).attr("href"));b("#redactor_image_delete_btn").click(b.proxy(function(){this.imageRemove(c)},this));b("#redactorSaveBtn").click(b.proxy(function(){this.imageSave(c)},
this))},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image_edit,380,a)},imageRemove:function(a){var c=b(a).parent();b(a).remove();c.length&&"P"===c[0].tagName&&(this.$editor.focus(),this.selectionStart(c));this.callback("imageDelete",a);this.modalClose();this.sync()},imageSave:function(a){var c=b(a).parent();b(a).attr("alt",b("#redactor_file_alt").val());var d=b("#redactor_form_image_align").val();"left"===d?b(a).css({"float":"left",margin:"0 10px 10px 0"}):"right"===d?b(a).css({"float":"right",
margin:"0 0 10px 10px"}):b(a).css({"float":"none",margin:"0"});d=b.trim(b("#redactor_file_link").val());""!==d?"A"!==b(c).get(0).tagName?b(a).replaceWith('<a href="'+d+'">'+this.outerHtml(a)+"</a>"):b(c).attr("href",d):"A"===b(c).get(0).tagName&&b(c).replaceWith(this.outerHtml(a));this.modalClose();this.observeImages();this.sync()},imageResize:function(a){var c=b(a),d=!1,e=!1,f,g=c.width()/c.height();c.off("hover mousedown mouseup click mousemove");c.hover(function(){c.css("cursor","nw-resize")},
function(){c.css("cursor","");d=!1});c.mousedown(function(a){a.preventDefault();g=c.width()/c.height();e=d=!0;Math.round(a.pageX-c.eq(0).offset().left);f=Math.round(a.pageY-c.eq(0).offset().top)});c.mouseup(b.proxy(function(a){d=!1;c.css("cursor","");this.sync()},this));c.click(b.proxy(function(a){e&&this.imageEdit(a)},this));c.mousemove(function(a){if(d){e=!1;Math.round(a.pageX-b(this).eq(0).offset().left);var k=Math.round(a.pageY-b(this).eq(0).offset().top)-f,l=c.height(),k=parseInt(l,10)+k,k=Math.round(k*
g);10<k&&c.width(k);Math.round(a.pageX-b(this).eq(0).offset().left);f=Math.round(a.pageY-b(this).eq(0).offset().top)}})},imageThumbClick:function(a){a='<img id="image-marker" src="'+b(a.target).attr("rel")+'" alt="'+b(a.target).attr("title")+'" />';this.opts.paragraphy&&(a="<p>"+a+"</p>");this.imageInsert(a,!0)},imageCallbackLink:function(){var a=b("#redactor_file_link").val();""!==a?(a='<img id="image-marker" src="'+a+'" />',!1===this.opts.linebreaks&&(a="<p>"+a+"</p>"),this.imageInsert(a,!0)):this.modalClose()},
imageCallback:function(a){this.imageInsert(a)},imageInsert:function(a,c){this.selectionRestore();if(!1!==a){var d="";!0!==c?(d='<img id="image-marker" src="'+a.filelink+'" />',this.opts.paragraphy&&(d="<p>"+d+"</p>")):d=a;this.execCommand("inserthtml",d,!1);d=b(this.$editor.find("img#image-marker"));d.length?d.removeAttr("id"):d=!1;this.sync();!0!==c&&this.callback("imageUpload",d,a)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){b.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+
this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="file" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label>'+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+
this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><a href="#" id="redactor_image_delete_btn" class="redactor_modal_btn">'+this.opts.curLang._delete+'</a>&nbsp;&nbsp;&nbsp;<a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+
'" /></footer>',modal_image:String()+'<section><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#">'+this.opts.curLang.choose+'</a><a href="#">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="file" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+
this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /></div></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+
this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+
this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+
this.opts.curLang.cancel+'</a><input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+
'</a><input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" class="redactor_modal_btn" id="redactor_insert_video_btn" value="'+
this.opts.curLang.insert+'" /></footer>'})},modalInit:function(a,c,d,e){var f=b("#redactor_modal_overlay");f.length||(this.$overlay=f=b('<div id="redactor_modal_overlay" style="display: none;"></div>'),b("body").prepend(this.$overlay));if(this.opts.modalOverlay)f.show().on("click",b.proxy(this.modalClose,this));var g=b("#redactor_modal");g.length||(this.$modal=g=b('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>'),
b("body").append(this.$modal));b("#redactor_modal_close").on("click",b.proxy(this.modalClose,this));this.hdlModalClose=b.proxy(function(a){if(a.keyCode===this.keyCode.ESC)return this.modalClose(),!1},this);b(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=!1;0==c.indexOf("#")?(this.modalcontent=b(c),b("#redactor_modal_inner").empty().append(this.modalcontent.html()),this.modalcontent.html("")):b("#redactor_modal_inner").empty().append(c);g.find("#redactor_modal_header").html(a);
"undefined"!==typeof b.fn.draggable&&(g.draggable({handle:"#redactor_modal_header"}),g.find("#redactor_modal_header").css("cursor","move"));var h=b("#redactor_tabs");if(h.length){var k=this;h.find("a").each(function(a,c){a++;b(c).on("click",function(c){c.preventDefault();h.find("a").removeClass("redactor_tabs_act");b(this).addClass("redactor_tabs_act");b(".redactor_tab").hide();b("#redactor_tab"+a).show();b("#redactor_tab_selected").val(a);!1===k.isMobile()&&(c=g.outerHeight(),g.css("margin-top",
"-"+(c+10)/2+"px"))})})}g.find(".redactor_btn_modal_close").on("click",b.proxy(this.modalClose,this));!1===this.isMobile()?(g.css({position:"fixed",top:"-2000px",left:"50%",width:d+"px",marginLeft:"-"+(d+60)/2+"px"}).show(),this.modalSaveBodyOveflow=b(document.body).css("overflow"),b(document.body).css("overflow","hidden")):g.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show();"function"===typeof e&&e();!1===this.isMobile()&&setTimeout(function(){var a=
g.outerHeight();g.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(a+10)/2+"px"})},20)},modalClose:function(){b("#redactor_modal_close").off("click",this.modalClose);b("#redactor_modal").fadeOut("fast",b.proxy(function(){var a=b("#redactor_modal_inner");!1!==this.modalcontent&&(this.modalcontent.html(a.html()),this.modalcontent=!1);a.html("");this.opts.modalOverlay&&b("#redactor_modal_overlay").hide().off("click",this.modalClose);b(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",
this.hdlModalClose);this.selectionRestore()},this));!1===this.isMobile()&&b(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible");return!1},modalSetTab:function(a){b(".redactor_tab").hide();b("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(a-1).addClass("redactor_tabs_act");b("#redactor_tab"+a).show()},s3handleFileSelect:function(a){a=a.target.files;for(var b=0,d;d=a[b];b++)this.s3uploadFile(d)},s3uploadFile:function(a){this.s3executeOnSignedUrl(a,
b.proxy(function(b){this.s3uploadToS3(a,b)},this))},s3executeOnSignedUrl:function(a,c){var d=new XMLHttpRequest;d.open("GET",this.opts.s3+"?name="+a.name+"&type="+a.type,!0);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(a){4==this.readyState&&200==this.status&&(b("#redactor-progress").fadeIn(),c(decodeURIComponent(this.responseText)))};d.send()},s3createCORSRequest:function(a,b){var d=new XMLHttpRequest;"withCredentials"in d?d.open(a,b,!0):"undefined"!=typeof XDomainRequest?
(d=new XDomainRequest,d.open(a,b)):d=null;return d},s3uploadToS3:function(a,c){var d=this.s3createCORSRequest("PUT",c);d&&(d.onload=b.proxy(function(){if(200==d.status){b("#redactor-progress").hide();var a=c.split("?");if(!a[0])return!1;this.selectionRestore();var f="",f='<img id="image-marker" src="'+a[0]+'" />';this.opts.paragraphy&&(f="<p>"+f+"</p>");this.execCommand("inserthtml",f,!1);a=b(this.$editor.find("img#image-marker"));a.length?a.removeAttr("id"):a=!1;this.sync();this.callback("imageUpload",
a,!1);this.modalClose();this.observeImages()}},this),d.onerror=function(){},d.upload.onprogress=function(a){},d.setRequestHeader("Content-Type",a.type),d.setRequestHeader("x-amz-acl","public-read"),d.send(a))},uploadInit:function(a,c){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1};b.extend(this.uploadOptions,c);var d=b("#"+a);d.length&&"INPUT"===d[0].tagName?(this.uploadOptions.input=d,this.el=b(d[0].form)):this.el=d;this.element_action=this.el.attr("action");
this.uploadOptions.auto?b(this.uploadOptions.input).change(b.proxy(function(a){this.el.submit(function(a){return!1});this.uploadSubmit(a)},this)):this.uploadOptions.trigger&&b("#"+this.uploadOptions.trigger).click(b.proxy(this.uploadSubmit,this))},uploadSubmit:function(a){b("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(99999*Math.random());var a=this.document.createElement("div");a.innerHTML='<iframe style="display:none" id="'+
this.id+'" name="'+this.id+'"></iframe>';b(a).appendTo("body");this.uploadOptions.start&&this.uploadOptions.start();b("#"+this.id).load(b.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(a,c){if(this.uploadOptions.input){var d="redactorUploadForm"+this.id,e="redactorUploadFile"+this.id;this.form=b('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+c+'" name="'+d+'" id="'+d+'" enctype="multipart/form-data" />');!1!==this.opts.uploadFields&&"object"===typeof this.opts.uploadFields&&
b.each(this.opts.uploadFields,b.proxy(function(a,c){null!=c&&0===c.toString().indexOf("#")&&(c=b(c).val());var d=b("<input/>",{type:"hidden",name:a,value:c});b(this.form).append(d)},this));var d=this.uploadOptions.input,f=b(d).clone();b(d).attr("id",e).before(f).appendTo(this.form);b(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else a.attr("target",c).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url),
this.element.submit()},uploadLoaded:function(){var a=b("#"+this.id)[0],a=a.contentDocument?a.contentDocument:a.contentWindow?a.contentWindow.document:window.frames[this.id].document;this.uploadOptions.success&&(b("#redactor-progress").hide(),"undefined"!==typeof a?(a=a.body.innerHTML.match(/\{(.|\n)*\}/)[0],a=a.replace(/^\[/,""),a=a.replace(/\]$/,""),a=b.parseJSON(a),"undefined"==typeof a.error?this.uploadOptions.success(a):(this.uploadOptions.error(this,a),this.modalClose())):(this.modalClose(),
alert("Upload failed!")));this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(a,c){this.draguploadOptions=b.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose},c);if(void 0===window.FormData)return!1;this.droparea=b('<div class="redactor_droparea"></div>');this.dropareabox=b('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>");this.dropalternative=b('<div class="redactor_dropalternative">'+
this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);b(a).before(this.droparea);b(a).before(this.dropalternative);this.dropareabox.on("dragover",b.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",b.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=b.proxy(function(a){a.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");this.draguploadUpload(a.dataTransfer.files[0])},this)},
draguploadUpload:function(a){var c=jQuery.ajaxSettings.xhr();c.upload&&c.upload.addEventListener("progress",b.proxy(this.uploadProgress,this),!1);var d=new FormData;!1!==this.draguploadOptions.uploadFields&&"object"===typeof this.draguploadOptions.uploadFields&&b.each(this.draguploadOptions.uploadFields,b.proxy(function(a,c){null!=c&&0===c.toString().indexOf("#")&&(c=b(c).val());d.append(a,c)},this));d.append("file",a);b.ajax({url:this.draguploadOptions.url,dataType:"html",data:d,xhr:function(){return c},
cache:!1,contentType:!1,processData:!1,type:"POST",success:b.proxy(function(a){a=a.replace(/^\[/,"");a=a.replace(/\]$/,"");a=b.parseJSON(a);"undefined"==typeof a.error?this.draguploadOptions.success(a):(this.draguploadOptions.error(this,a),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return!1},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return!1},uploadProgress:function(a,b){var d=a.loaded?parseInt(100*(a.loaded/
a.total),10):a;this.dropareabox.text("Loading "+d+"% "+(b||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},normalize:function(a){return"undefined"===typeof a?0:parseInt(a.replace("px",""),10)},outerHtml:function(a){return b("<div>").append(b(a).eq(0).clone()).html()},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isEmpty:function(a){a=a.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");a=a.replace(/\s/g,"");a=a.replace(/^<p>[^\w\d]*?<\/p>$/i,
"");return""==a},browser:function(a){var b=navigator.userAgent.toLowerCase(),b=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];return"version"==a?b[2]:"webkit"==a?"chrome"==b[1]||"webkit"==b[1]:b[1]==a},oldIE:function(){return this.browser("msie")&&9>parseInt(this.browser("version"),10)?!0:!1},getFragmentHtml:function(a){a=a.cloneNode(!0);
var b=this.document.createElement("div");b.appendChild(a);return b.innerHTML},extractContent:function(){for(var a=this.$editor[0],b=this.document.createDocumentFragment(),d;d=a.firstChild;)b.appendChild(d);return b},isParentRedactor:function(a){return a?this.opts.iframe?a:0==b(a).parents("div.redactor_editor").length||b(a).hasClass("redactor_editor")?!1:a:!1},currentOrParentIs:function(a){var b=this.getParent(),d=this.getCurrent();return b&&b.tagName===a?b:d&&d.tagName===a?d:!1},isEndOfElement:function(){var a=
this.getBlock(),c=this.getCaretOffset(a),a=b.trim(b(a).text()).replace(/\n\r\n/g,"").length;return c==a?!0:!1},isFocused:function(){var a,c=this.getSelection();c&&(c.rangeCount&&0<c.rangeCount)&&(a=c.getRangeAt(0).startContainer);return a?this.opts.iframe?this.getCaretOffsetRange().equals()?!this.$editor.is(a):!0:0!=b(a).closest("div.redactor_editor").length:!1},removeEmptyAttr:function(a,c){""==b(a).attr(c)&&b(a).removeAttr(c)},removeFromArrayByValue:function(a,b){for(var d=null;-1!==(d=a.indexOf(b));)a.splice(d,
1);return a}};m.prototype.init.prototype=m.prototype;b.Redactor.fn.formatLinkify=function(a){for(var c=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,d=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,e=(this.$editor?this.$editor.get(0):this).childNodes,f=e.length;f--;){var g=e[f];if(3===g.nodeType){var h=g.nodeValue;h&&(h.match(c)||h.match(d))&&(h=h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(c,'$1<a href="'+a+'$2">$2</a>$3').replace(d,'$1<a href="$2">$2</a>$5'),b(g).after(h).remove())}else 1!==
g.nodeType||/^(a|button|textarea)$/i.test(g.tagName)||b.Redactor.fn.formatLinkify.call(g,a)}}})(jQuery);
