{if embed:height}{exp:stash:set name="retina-height"}{exp:math_plus calculate='({var2} * 2)' var2='{embed:height}'}{math_plus_result}{/exp:math_plus}{/exp:stash:set}{/if}
{if embed:width}{exp:stash:set name="retina-width"}{exp:math_plus calculate='({var1} * 2)' var1='{embed:width}'}{math_plus_result}{/exp:math_plus}{/exp:stash:set}{/if}
{if embed:max_height}{exp:stash:set name="retina-max-height"}{exp:math_plus calculate='({var2} * 2)' var2='{embed:max_height}'}{math_plus_result}{/exp:math_plus}{/exp:stash:set}{/if}
{if embed:max_width}{exp:stash:set name="retina-max-width"}{exp:math_plus calculate='({var1} * 2)' var1='{embed:max_width}'}{math_plus_result}{/exp:math_plus}{/exp:stash:set}{/if}


{!-- normal version --}
{exp:ce_img:single
  src='{embed:src}'
  width='{embed:width}'
  height='{embed:height}'
  width='{embed:max_width}'
  height='{embed:max_height}'
  crop='{embed:crop}'
  url_only='{embed:url_only}'
  allow_scale_larger='yes'
  filename='{embed:filename}_{embed:width}{embed:max_width}_{embed:height}{embed:max_height}'
  unique='none'
  attributes='class="{embed:class}" alt="{embed:alt}" title="{embed:title}"'
}
{!-- retina version --}
{exp:ce_img:single
  parse='inward'
  src='{embed:src}'
  height='{exp:stash:get name="retina-height"}'
  width='{exp:stash:get name="retina-width"}'
  width='{embed:max_width}'
  height='{embed:max_height}'
  crop='{embed:crop}'
  allow_scale_larger='yes'
  filename='{embed:filename}_{embed:width}{embed:max_width}_{embed:height}{embed:max_height}'
  filename_suffix='@2x'
  unique='none'
  output=' '
}